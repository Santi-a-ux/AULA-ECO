<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Reciclaje - Aula-Eco</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --verde-principal: #2e7d32;
            --verde-claro: #81c784;
            --verde-oscuro: #1b5e20;
            --beige: #f5f5dc;
            --marron: #5d4037;
            --blanco: #ffffff;
            --gris-claro: #f9f9f9;
            --azul: #1976d2;
            --naranja: #ff9800;
            --rojo: #e53935;
            --gris: #607d8b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--beige);
            color: var(--marron);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--verde-principal);
            color: var(--blanco);
            padding: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: var(--blanco);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav a:hover {
            color: var(--verde-claro);
        }
        
        .page-title {
            background: linear-gradient(rgba(46, 125, 50, 0.8), rgba(27, 94, 32, 0.8)), url('https://images.unsplash.com/photo-1532996122724-e3cfc4d2ca9d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80') center/cover;
            color: var(--blanco);
            padding: 3rem 0;
            text-align: center;
        }
        
        .page-title h2 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .page-title p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .dashboard {
            padding: 3rem 0;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .dashboard-title {
            color: var(--verde-principal);
            font-size: 1.8rem;
        }
        
        .dashboard-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background-color: var(--blanco);
            border: 1px solid var(--verde-principal);
            color: var(--verde-principal);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active, .filter-btn:hover {
            background-color: var(--verde-principal);
            color: var(--blanco);
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background-color: var(--blanco);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--blanco);
        }
        
        .stat-icon.blue {
            background-color: var(--azul);
        }
        
        .stat-icon.green {
            background-color: var(--verde-principal);
        }
        
        .stat-icon.orange {
            background-color: var(--naranja);
        }
        
        .stat-icon.red {
            background-color: var(--rojo);
        }
        
        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
            color: var(--verde-oscuro);
        }
        
        .stat-info p {
            color: var(--marron);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 3rem;
        }
        
        .chart-card {
            background-color: var(--blanco);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            color: var(--verde-principal);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .recycling-table {
            background-color: var(--blanco);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
        }
        
        .table-header {
            background-color: var(--verde-principal);
            color: var(--blanco);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            font-size: 1.3rem;
        }
        
        .table-content {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--gris-claro);
            color: var(--verde-oscuro);
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: var(--gris-claro);
        }
        
        .material-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--blanco);
        }
        
        .material-tag.plastic {
            background-color: var(--azul);
        }
        
        .material-tag.paper {
            background-color: var(--verde-principal);
        }
        
        .material-tag.glass {
            background-color: var(--naranja);
        }
        
        .material-tag.metal {
            background-color: var(--gris);
        }
        
        .material-tag.organic {
            background-color: var(--rojo);
        }
        
        .material-tag.otro {
            background-color: var(--naranja);
        }
        /* Nuevos materiales */
        .material-tag.tetra { background-color: #8d6e63; }
    .material-tag.pp { background-color: #26a69a; }
    .material-tag.aluminio { background-color: #607d8b; }
        
        footer {
            background-color: var(--verde-oscuro);
            color: var(--blanco);
            padding: 3rem 0 1rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 2rem;
        }
        
        .footer-column h3 {
            margin-bottom: 1.5rem;
            position: relative;
            padding-bottom: 10px;
        }
        
        .footer-column h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: var(--verde-claro);
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column a {
            color: var(--blanco);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-column a:hover {
            color: var(--verde-claro);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
        }
        
        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
        }
        
        .social-links a:hover {
            background-color: var(--verde-claro);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <h1>Aula-Eco</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="prinpal_si_1.html">Inicio</a></li>
                    <li><a href="prinpal_si_1.html#videos">Educación</a></li>
                    <li><a href="add_recycling.html">Agregar Reciclaje</a></li>
                    <li><a href="body_principal.html" class="active">Estadísticas</a></li>
                    <li><a href="#" id="login-btn" class="btn" style="padding: 8px 16px; font-size: 0.9rem;">Iniciar Sesión</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="page-title">
        <div class="container">
            <h2>Estadísticas de Reciclaje</h2>
            <p>Monitorea el impacto ambiental de tus acciones de reciclaje y descubre cómo contribuyes a un planeta más sostenible.</p>
        </div>
    </section>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Panel de Control</h2>
                <div class="dashboard-filters">
                    <button class="filter-btn active" id="filter-week">Última Semana</button>
                    <button class="filter-btn" id="filter-month">Último Mes</button>
                    <button class="filter-btn" id="filter-year">Último Año</button>
                </div>
            </div>

            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-recycle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0</h3>
                        <p>Total de Registros</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0</h3>
                        <p>Total de Objetos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0</h3>
                        <p>Puntos Totales</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>0</h3>
                        <p>Usuarios Activos</p>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>Objetos por Tipo de Material</h3>
                    <div class="chart-container">
                        <canvas id="materialChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Evolución (Objetos en los últimos meses)</h3>
                    <div class="chart-container">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="recycling-table">
                    <div class="table-header">
                        <h3>Registros de Reciclaje Recientes</h3>
                    </div>
                <div class="table-content">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Material</th>
                                <th>Objeto</th>
                                <th>Cantidad</th>
                                <th>Puntos</th>
                                <th>Centro de Reciclaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align:center; padding:40px; color:#666; font-style:italic;">
                                    <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                                    Cargando registros...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Aula-Eco</h3>
                    <p>Plataforma educativa para la conciencia ambiental y promoción del reciclaje en comunidades.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Enlaces Rápidos</h3>
                    <ul>
                        <li><a href="prinpal_si_1.html">Inicio</a></li>
                        <li><a href="#">Educación</a></li>
                        <li><a href="body_principal.html">Estadísticas</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contacto</h3>
                    <ul>
                        <li><i class="fas fa-envelope"></i> info@aula-eco.org</li>
                        
                        <li><i class="fas fa-map-marker-alt"></i> Medellín, Colombia</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Aula-Eco. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
    const API_BASE = 'http://localhost:3000/api';
    let currentFilter = 'week'; // week | month | year
    // Mantener referencias a las instancias de Chart.js para evitar crear múltiples charts sobre el mismo canvas
    let materialChartInstance = null;
    let evolutionChartInstance = null;

        // Verificar login al cargar
        const token = localStorage.getItem('aula_token');
        const role = localStorage.getItem('aula_role');
        const isGuest = !token;

        // Si no hay token, no salimos: mostramos un banner y cargamos datos públicos
        if (isGuest) {
            const dashboard = document.querySelector('.dashboard');
            dashboard.insertAdjacentHTML('beforebegin', '<div style="text-align:center;padding:20px;background:#fff8e1;color:#8d6e63;border:1px solid #ffe0b2;"><h2>Modo Invitado</h2><p>Estás viendo datos globales públicos. <a href="login.html">Inicia sesión</a> para ver tus estadísticas personales.</p></div>');
        }

    // Código que se ejecuta solo si hay token
        // Si admin, agregar botón admin
        if (role === 'admin') {
            const header = document.querySelector('.table-header h3');
            header.innerHTML += ' <button id="admin-btn" class="btn" style="padding: 8px 16px; font-size: 0.9rem; margin-left:10px;">Vista Admin</button>';
            document.getElementById('admin-btn').addEventListener('click', () => {
                window.location.href = 'admin.html';
            });
        }

        // Utilidades para token
        function getToken() {
            return localStorage.getItem('aula_token');
        }

        // Utilidades de filtro y clases
        function getFromDateForFilter() {
            const now = new Date();
            const days = currentFilter === 'week' ? 7 : currentFilter === 'month' ? 30 : 365;
            const from = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
            return from.toISOString().slice(0, 10);
        }

        const materialClassMap = {
            'Tetra Pak': 'tetra',
            'Plástico PP': 'pp',
            'Aluminio': 'aluminio',
            'Otro': 'otro'
        };

        // Cargar estadísticas del panel
        async function loadStatsPanel() {
            try {
                const statCards = document.querySelectorAll('.stat-card');
                
                if (!isGuest && role === 'admin') {
                    // Para admin: datos globales
                    const from = getFromDateForFilter();
                    const res = await fetch(`${API_BASE}/global-stats?from=${from}`, {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    if (!res.ok) throw new Error('No autorizado');
                    const data = await res.json();
                    
                    statCards[0].querySelector('h3').textContent = data.total_records;
                    statCards[1].querySelector('h3').textContent = (data.total_qty || 0);
                    statCards[2].querySelector('h3').textContent = data.total_points;
                    
                    // Obtener número de usuarios únicos (sin filtrar por fecha para reflejar todos los usuarios existentes)
                    const usersRes = await fetch(`${API_BASE}/admin/recyclings`, {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    if (usersRes.ok) {
                        const usersData = await usersRes.json();
                        const uniqueUsers = new Set(usersData.items.map(r => r.user_id)).size;
                        statCards[3].querySelector('h3').textContent = uniqueUsers;
                    }
                } else if (!isGuest) {
                    // Para usuarios normales: sus propios datos
                    const from = getFromDateForFilter();
                    const res = await fetch(`${API_BASE}/me/records?from=${from}`, {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    if (!res.ok) throw new Error('No autorizado');
                    const data = await res.json();
                    
                    const totalRecords = data.items.length;
                    const totalQty = data.items.reduce((sum, r) => sum + (r.kg || 0), 0);
                    const totalPoints = data.items.reduce((sum, r) => sum + (r.points || 0), 0);
                    
                    statCards[0].querySelector('h3').textContent = totalRecords;
                    statCards[1].querySelector('h3').textContent = totalQty.toString();
                    statCards[2].querySelector('h3').textContent = totalPoints;
                    statCards[3].querySelector('h3').textContent = '1'; // Solo el usuario actual
                } else {
                    // Invitado: calcular a partir de datos públicos
                    const from = getFromDateForFilter();
                    const res = await fetch(`${API_BASE}/public/recyclings?from=${from}`);
                    const data = await res.json();
                    const items = data.items || [];
                    const totalRecords = items.length;
                    const totalQty = items.reduce((s, r) => s + (r.kg || 0), 0);
                    const totalPoints = items.reduce((s, r) => s + (r.points || 0), 0);
                    const uniqueUsers = new Set(items.map(r => r.user_id)).size || 0;
                    statCards[0].querySelector('h3').textContent = totalRecords;
                    statCards[1].querySelector('h3').textContent = totalQty.toString();
                    statCards[2].querySelector('h3').textContent = totalPoints;
                    statCards[3].querySelector('h3').textContent = uniqueUsers.toString();
                }
            } catch (err) {
                console.error('Error cargando estadísticas del panel:', err);
            }
        }

        // Cargar datos para materiales y renderizar doughnut
        async function loadMaterialChart() {
            try {
                let labels = [];
                let data = [];
                if (isGuest) {
                    const from = getFromDateForFilter();
                    const pub = await fetch(`${API_BASE}/public/recyclings?from=${from}`);
                    const js = await pub.json();
                    const items = js.items || [];
                    const map = {};
                    items.forEach(r => { const m = (r.material || 'Otro'); map[m] = (map[m] || 0) + (r.kg || 0); });
                    labels = Object.keys(map).sort();
                    data = labels.map(l => Number(map[l] || 0));
                } else {
                    const from = getFromDateForFilter();
                    const res = await fetch(`${API_BASE}/stats?from=${from}`, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                    if (!res.ok) throw new Error('No autorizado');
                    const json = await res.json();
                    labels = json.stats.map(s => s.material);
                    data = json.stats.map(s => s.total_qty);
                }
                renderMaterialChart(labels, data);
            } catch (err) {
                console.error('Error cargando materiales:', err);
                // Fallback
                renderMaterialChart(['Tetra Pak', 'Plástico PP', 'Aluminio'], [12, 8, 10]);
            }
        }

        function renderMaterialChart(labels, data) {
            const ctx = document.getElementById('materialChart').getContext('2d');
            // Destruir instancia anterior si existía
            if (materialChartInstance) {
                try { materialChartInstance.destroy(); } catch (e) { /* ignore */ }
            }
            materialChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data.map(n => Number(n || 0)),
                        backgroundColor: ['#1976d2','#2e7d32','#ff9800','#607d8b','#e53935','#8d6e63','#26a69a'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    cutout: '50%'
                }
            });
        }

        // Cargar evolución (inventada basada en datos)
        async function loadEvolutionChart() {
            try {
                let labels = [];
                let data = [];
                if (isGuest) {
                    const from = getFromDateForFilter();
                    const pub = await fetch(`${API_BASE}/public/recyclings?from=${from}`);
                    const js = await pub.json();
                    const items = js.items || [];
                    const map = {};
                    items.forEach(r => { const k = (r.date || '').slice(0,7); if (!k) return; map[k] = (map[k] || 0) + (r.kg || 0); });
                    labels = Object.keys(map).sort();
                    data = labels.map(l => Number(map[l] || 0));
                } else {
                    const from = getFromDateForFilter();
                    const res = await fetch(`${API_BASE}/evolution?from=${from}`, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                    if (!res.ok) throw new Error('No autorizado');
                    const json = await res.json();
                    labels = json.evolution.map(e => e.month);
                    data = json.evolution.map(e => e.total_qty);
                }
                renderEvolutionChart(labels, data);
            } catch (err) {
                console.error('Error cargando evolución:', err);
                // Fallback
                renderEvolutionChart(['2023-08', '2023-09', '2023-10'], [10, 15, 20]);
            }
        }

        function renderEvolutionChart(labels, data) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if (evolutionChartInstance) {
                try { evolutionChartInstance.destroy(); } catch (e) { /* ignore */ }
            }
            evolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Objetos reciclados (unidades)',
                        data: data.map(n => Number(n || 0)),
                        backgroundColor: 'rgba(46, 125, 50, 0.2)',
                        borderColor: '#2e7d32',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // Cargar tabla de registros
        async function loadRecordsTable() {
            try {
                // Usar endpoint diferente según el rol
                let json;
                const from = getFromDateForFilter();
                if (isGuest) {
                    const res = await fetch(`${API_BASE}/public/recyclings?from=${from}`);
                    json = await res.json();
                } else {
                    const endpoint = role === 'admin' ? `/admin/recyclings?from=${from}` : `/me/records?from=${from}`;
                    const res = await fetch(`${API_BASE}${endpoint}`, { headers: { 'Authorization': 'Bearer ' + getToken() } });
                    if (!res.ok) throw new Error('No autorizado');
                    json = await res.json();
                }
                
                // Actualizar headers según rol
                const thead = document.querySelector('table thead tr');
                if (!isGuest && role === 'admin') {
                    thead.innerHTML = `
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Material</th>
                        <th>Objeto</th>
                        <th>Cantidad</th>
                        <th>Puntos</th>
                        <th>Centro de Reciclaje</th>
                    `;
                } else {
                    thead.innerHTML = `
                        <th>Fecha</th>
                        <th>Material</th>
                        <th>Objeto</th>
                        <th>Cantidad</th>
                        <th>Puntos</th>
                        <th>Centro de Reciclaje</th>
                    `;
                }
                
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                
                // Para admin mostrar username, para usuarios normales no
                json.items.forEach(r => {
                    const tr = document.createElement('tr');
                    // Validar material
                    const materialClass = (materialClassMap[r.material]) || 'otro';
                    
                    if (!isGuest && role === 'admin') {
                        tr.innerHTML = `
                            <td>${r.username || 'N/A'}</td>
                            <td>${new Date(r.date).toLocaleDateString()}</td>
                            <td><span class="material-tag ${materialClass}">${r.material || 'Desconocido'}</span></td>
                            <td>${r.item || ''}</td>
                            <td>${r.kg || 0}</td>
                            <td>${r.points || ''}</td>
                            <td>${r.center || 'intermediario de reciclaje S.A.S'}</td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td>${new Date(r.date).toLocaleDateString()}</td>
                            <td><span class="material-tag ${materialClass}">${r.material || 'Desconocido'}</span></td>
                            <td>${r.item || ''}</td>
                            <td>${r.kg || 0}</td>
                            <td>${r.points || ''}</td>
                            <td>${r.center || 'intermediario de reciclaje S.A.S'}</td>
                        `;
                    }
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error cargando registros:', err);
            }
        }

        // Inicializar
        loadStatsPanel();
        loadMaterialChart();
        loadEvolutionChart();
        loadRecordsTable(); // Cargar registros automáticamente al iniciar

        // Filtros funcionales
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (btn.id === 'filter-week') currentFilter = 'week';
                else if (btn.id === 'filter-month') currentFilter = 'month';
                else if (btn.id === 'filter-year') currentFilter = 'year';
                // Recargar data
                loadStatsPanel();
                loadMaterialChart();
                loadEvolutionChart();
                loadRecordsTable();
            });
        });

        // Se eliminó el formulario rápido de "Añadir Registro" en esta página para mantener la creación solo desde la opción "Agregar Reciclaje" del menú.

        // Exportar (placeholder)
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                alert('Función de exportar no implementada aún');
            });
        }

        // Manejar botón de login
        const loginBtn = document.getElementById('login-btn');
        if (token) {
            loginBtn.textContent = 'Cerrar Sesión';
            loginBtn.onclick = () => {
                localStorage.removeItem('aula_token');
                localStorage.removeItem('aula_role');
                location.reload();
            };
        } else {
            loginBtn.onclick = () => window.location.href = 'login.html';
        }
    </script>
</body>
</html>
